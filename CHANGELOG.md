# CHANGELOG

07/09/2024
-  For those interested in the KLOR project I have finished developping a new version of KLOR PCB with an important revision 1.5 bringing the following upgrades:

![image](https://github.com/user-attachments/assets/d352a5f1-c9b1-4716-9df1-823539923590)


   -  Significant improvement of the power distribution topology : direct USB 5V powering of the LED strips with inline capacitance, distribution of the 5V supply between both sides to share the load between both MCU regulators with RX/TX voltage clamping protection. Original design relied on the master side MCU linear voltage regulator to power both keyboard halves + LED strings + onboard I2C devices. This resulted in very high load on a single linear regulator added to the fact that ARGB LED strings and OLED displays are designed to run on direct 5V out of the box and will operate nominaly at this voltage (higher brightness and less heat generated by the regulators).
   -  On board soldered haptic module allowing more switch options and better transmission of vibrations
   -  Ability to chose the OLED primary voltage to 5V or 3.3V
   -  Dedicated LED for NUM, CAPS and SCROLL lock status for implementations without OLED displays
   -  Support of PS2 and I2C pointing devices with ability to select protocol and primary voltage to 5V or 3.3V
   -  RP2040 Promicro full pinout support
   -  Ability to set the handedness at hardware level
   -  Ability to set the TRRS wiring with symmetrical or inverted pinout for full duplex serial communications  
   -  South facing SK6812 Mini-E for all versions
   -  Exists in full height switch, low profile Gateron KS33 and low profile Kailh V2
   -  Still compatible with all ProMicro boards, optimized for QMK on RP2040

-  I should get the first PCBs tomorrow for first builds, stay tuned!!

01/09/2024
-  While working on a revision of the PCB, I noticed another issue in the original design. If using the TRRS connection on a wired build, the master MCU board is actually powering the totality of the keyboard with its 3.3V voltage regulator as the TRRS transports the down converted 3.3V to the secondary MCU VCC, thus bypassing its regulator. This means that the two MCU, the two LED strips and the I2C devices get their 3.3V from the regulator of the master MCU board only, which tends to overheat quite a bit and is most likely not designed for such a heavy load. Another issue with this topology is that the ARGB LED typically require 5V VCC to operate nominaly, while in this case they are powered with 3.3V only. It works but it is completly unnecessary to down convert the USB/Battery voltage to 3.3V for the LED strips. Note that this has nothing to do with the contol logic level which MUST be at 3.3V. I will be addressing those issues on a 1.5 revision coming soon...

31/08/2024
-  Added support for VIAL firmware for RP2040 boards. You can now compile :
   
      the "default" layout using [QMK toolchain](https://github.com/qmk/qmk_firmware) and the command :

            qmk compile -kb klor -km default -c
   
      or "vial" layout using [vial-qmk toolchain](https://github.com/vial-kb/vial-qmk) and the command :

            make clean && make klor:vial
   
-   NB : In both cases I had to modify the file ./platforms/chibios/boards/QMK_PM2040/configs/mcuconf.h and change the line :

           #define RP_PWM_USE_PWM4                     FALSE
           to
           #define RP_PWM_USE_PWM4                     TRUE
    
-   Also be aware that I have now enabled firmware based handedness definition ([#define EE_HANDS setting](https://docs.qmk.fm/features/split_keyboard)) so you should flash the firmware using the following commands for left and right keyboard sides :
-   
   For QMK environment
    
             qmk flash -kb klor -km default -c -bl uf2-split-left
             qmk flash -kb klor -km default -c -bl uf2-split-right
    
  For VIAL-QMK environment
     
             qmk flash -kb klor -km vial -c -bl uf2-split-left
             qmk flash -kb klor -km vial -c -bl uf2-split-right

-  Make sure you switch your serial communication to HALF DUPLEX as software pin swap used for full duplex does not seem to work well with firmware based handedness detection. If you alyays want to plug one side of the keyboard then you can set the master side in config.h and switch to full duplex with software pin swap. This will require a little testing but it will work eventually

28/08/2024
-  While playing with QMK I have noticed that the original 1.3 design carried a wiring flaw on the minijack footprint and PCB traces. The RX/TX are symetrical between the two sides which makes it impossible to define the transmission protocol in QMK as serial full duplex with RP2040 ProMicro boards if you don't specify a pin swap command. By default the stock firmware uses bitbang driver on a single pin which is not optimal and made the use of a TRRS link unnecessary as 3 pins cable would suffice. If you use these boards you should set the following in the config.h for QMK if using RP2040 ProMicro boards.
      
                  //Full Duplex communication
                  #define SERIAL_USART_TX_PIN GP4     // USART TX pin
                  #define SERIAL_USART_RX_PIN GP1     // USART RX pin
                  #define SERIAL_USART_FULL_DUPLEX
                  #define SERIAL_USART_PIN_SWAP

-  In case your MCU can only use a single pin for communications, it is recommended to use half duplex serial instead of bitbang.
      
                  //Half Duplex communication
                  //#define SERIAL_USART_TX_PIN GP1     // USART TX pin
       
-  More about this matter [here](https://docs.qmk.fm/drivers/serial)

27/08/2024
-  Validation of the alternative haptic module. You may now add it to your existing board. It is working great
-  Did some minimal tracks cleanup on all versions with Kicad cleanup tools. It was mainly some unmerged tracks.
-  Moved all files to Kicad 8 version. Please upgrade your version if required.
-  At the request of some users of the community I have made an initial "special" low profile version for KS33/V2 Gateron switches with south facing LED. Beware that this version is untested yet in terms of production validation. It will most likely be fabricated by JLCPB as it clears DRC, but I haven't assembled one yet. Also keep in mind the following points :

    - There will be some interferences with the haptic module as there is no way I can move it up sufficiently on the existing PCB cutout. I would have to redesign the top corner which would impact enclosure compatibility. Haptic module can be mounted but it will have to be a little bit spaced from the back of the PCB to clear the switch socket.
    - I have moved the puck mounting holes up a little bit. It now sits in between the 1.3 and 1.4 positions
    - Because the KS33 hotswaps have a very diferent pinout compared with standard Cherry, they don't play as well with the recto-verso design of the KLOR. In particular you may find to lack a little bit of soldering surface on the right pad. It should be just enough to solder the pad. This is due to the pad interfering with the other side hole. Nothing I can do here apart from duplicating the design for right and left sides.
    - Obviously you will need some Gateron low profile V2 hotswap sockets for this version (compatible with Gateron KS33/V2 low profile type switches). These are easilly obtainable on Aliexpress I use them for another project.Only Gateron low profile V2 sockets can be used. No other brands will work on this design.

23/08/2024
-  Upddated FIRMWARE directory with working config files for QMK for RP2040 and ZMK for NiceNanoV2. These are not perfect but both firmware compile without errors and have the maximum functionalities enabled by default.
-  Added precompiled [qmk](https://github.com/Lefuneste83/KLOR/tree/main/FIRMWARE/Ready-to-flash/qmk-RP2040) and [zmk](https://github.com/Lefuneste83/KLOR/tree/main/FIRMWARE/Ready-to-flash/zmk-NiceNanoV2) firmware
-  For extra convienence if you intend to modify your firmware for a smaller layout, I have created a link to :

    -  A [full POLYDACTYL layout](http://www.keyboard-layout-editor.com/#/gists/8ff2b448f2ef6c56c2b932e83ebf040f)
    -  A [KONRAD layout](http://www.keyboard-layout-editor.com/#/gists/49ff09e68b46feb39760467424a4601a)
    -  A [YUBITSUME layout](http://www.keyboard-layout-editor.com/#/gists/dc3fdb427b3102ccbf85252e2e278918)
    -  A [SAEGEWERK layout](http://www.keyboard-layout-editor.com/#/gists/b3775d73a84de0d544ea3bf84bafb047)

09/08/2024
- Correction of a 0.45 mm interference between hot swap socket and bottom of haptic buzz module. The module has been moved upwards by 0.6 mm to clear the interference for those willing to install the stock haptic module.
- An alternative design for a DIY haptic module is included if you can get a DRV2605LDGSR driver chip and a ELV1411A linear motor. Hot air/plate soldering is required. This module is 0.8 mm shorter so there will definitely be no interference whatever version of PCB you have. Attachment hole placment is unchanged relative to motor and pins locations in order to preserve mechanical compatibility. I recommend a thinner PCB (1.2 mm) for this module.

07/08/2024
-  Production validation of the new design. Full build completed and tested. Current Paste Layers are functionnal for those willing to order stencils.

25/07/2024
-  Initial commit with refactored PCB design for SK6812 Mini-E South facing ARGB LEDs

30/07/2024
-  Correction to SMD footprints for Paste Layers for diodes, reset switch and speaker.
-  ZMK Firmware modifications in order to be able to set per rotation pulses for each encoder. Both encoders work as expected. RGB light has been enabled by default as well.

--> If you intend to generate your own gerbers instead of the ones provided, make sure to process drill files AND flag the "Substract soldermask layer from copper pads" option (otherwise the KLOR Logo will superimpose on some of the SMD pads rendering soldering impossible without manual scratching of the covered pads). Guess how I know...
